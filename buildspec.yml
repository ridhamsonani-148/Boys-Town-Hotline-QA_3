version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 20
    commands:
      - echo "ğŸš€ Boys Town Hotline QA Deployment Started"
      - echo "Installing AWS CDK CLI..."
      - npm install -g aws-cdk@latest
      - echo "Installing project dependencies..."
      - npm install
      - echo "Installing jq for JSON processing..."
      - yum install -y jq 2>/dev/null || apt-get update && apt-get install -y jq 2>/dev/null || echo "jq installation skipped"

  pre_build:
    commands:
      - echo "ğŸ“‹ Pre-build phase started on $(date)"
      - echo "Checking AWS CLI configuration..."
      - aws sts get-caller-identity --query 'Account' --output text > /dev/null 2>&1 && echo "âœ… AWS CLI configured" || (echo "âŒ AWS CLI not configured" && exit 1)
      - echo ""
      - echo "ğŸ“‹ Environment Configuration:"
      - echo "COMPANY_NAME:$COMPANY_NAME"
      - echo "GITHUB_OWNER:$GITHUB_OWNER"
      - echo "GITHUB_REPO:$GITHUB_REPO"
      - echo "GITHUB_TOKEN_SECRET:[REDACTED]"
      - echo "AWS_REGION:$AWS_REGION"
      - echo "ACTION:$ACTION"
      - echo ""
      - echo "ğŸ“¦ Building TypeScript project..."
      - npm run build
      - echo "âœ… TypeScript build completed"

  build:
    commands:
      - echo "ğŸ—ï¸  Build phase started on $(date)"
      - echo "Setting up CDK environment..."
      - ACCOUNT=$(aws sts get-caller-identity --query Account --output text)
      - echo "Account:[REDACTED], Region:$AWS_REGION"

      - echo "ğŸ”§ Checking CDK bootstrap status..."
      - |
        if ! aws cloudformation describe-stacks --stack-name CDKToolkit --region $AWS_REGION > /dev/null 2>&1; then
          echo "ğŸ”§ Bootstrapping CDK..."
          cdk bootstrap aws://$ACCOUNT/$AWS_REGION
        else
          echo "âœ… CDK already bootstrapped"
        fi

      - echo "ğŸ” Validating GitHub token secret..."
      - |
        if ! aws secretsmanager describe-secret --secret-id "$GITHUB_TOKEN_SECRET" --region "$AWS_REGION" > /dev/null 2>&1; then
          echo "âŒ ERROR: GitHub token secret not found"
          echo "This should have been created by the deploy.sh script"
          exit 1
        fi
        echo "âœ… GitHub token secret validated"

      - |
        if [ "$ACTION" = "destroy" ]; then
          echo "ğŸ—‘ï¸  Destroying Boys Town Hotline QA system..."
          echo "Destroying main application stack..."
          cdk destroy HotlineQaStack-prod \
            --context envName=prod \
            --context bucketNamePrefix=${COMPANY_NAME}-hotline-qa \
            --context deployFrontend=true \
            --context githubOwner=$GITHUB_OWNER \
            --context githubRepo=$GITHUB_REPO \
            --context githubTokenSecretName=$GITHUB_TOKEN_SECRET \
            --force || echo "Stack may not exist or already destroyed"
          
          echo "ğŸ—‘ï¸  Cleaning up GitHub token secret..."
          aws secretsmanager delete-secret \
            --secret-id "$GITHUB_TOKEN_SECRET" \
            --region "$AWS_REGION" \
            --force-delete-without-recovery || echo "Secret may not exist"
          
          echo "âœ… Destroy process completed"
        else
          echo "ğŸš€ Deploying Boys Town Hotline QA system..."
          echo "This will take 10-15 minutes to complete..."
          
          cdk deploy HotlineQaStack-prod \
            --context envName=prod \
            --context bucketNamePrefix=${COMPANY_NAME}-hotline-qa \
            --context deployFrontend=true \
            --context githubOwner=$GITHUB_OWNER \
            --context githubRepo=$GITHUB_REPO \
            --context githubTokenSecretName=$GITHUB_TOKEN_SECRET \
            --require-approval never
          
          echo "âœ… Initial deployment completed successfully!"
        fi

  post_build:
    commands:
      - echo "ğŸ“‹ Post-build phase started on $(date)"
      - |
        if [ "$ACTION" = "deploy" ]; then
          echo "ğŸ”„ Starting automated CORS configuration update..."
          
          # Get deployment outputs for CORS update
          STACK_NAME="HotlineQaStack-prod"
          echo "ğŸ“Š Retrieving deployment outputs from stack: $STACK_NAME"
          
          BUCKET_NAME=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --region $AWS_REGION --query "Stacks[0].Outputs[?OutputKey=='BucketName'].OutputValue" --output text)
          AMPLIFY_APP_URL=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --region $AWS_REGION --query "Stacks[0].Outputs[?OutputKey=='AmplifyAppUrl'].OutputValue" --output text)
          
          echo "ğŸ“‹ CORS Update Configuration:"
          echo "S3 Bucket: $BUCKET_NAME"
          echo "Amplify URL: $AMPLIFY_APP_URL"
          
          if [ ! -z "$AMPLIFY_APP_URL" ] && [ "$AMPLIFY_APP_URL" != "None" ]; then
            echo "ğŸ”’ Updating CORS configuration to restrict to: $AMPLIFY_APP_URL"
            
            # Update S3 CORS
            echo "ğŸ“¦ Updating S3 CORS configuration..."
            aws s3api put-bucket-cors \
              --bucket "$BUCKET_NAME" \
              --cors-configuration '{
                "CORSRules": [
                  {
                    "AllowedHeaders": ["*"],
                    "AllowedMethods": ["GET", "PUT", "POST", "HEAD"],
                    "AllowedOrigins": ["'"$AMPLIFY_APP_URL"'"],
                    "MaxAgeSeconds": 3000,
                    "ExposeHeaders": ["ETag", "x-amz-server-side-encryption"]
                  }
                ]
              }' \
              --region "$AWS_REGION"
            
            echo "âœ… S3 CORS updated successfully"
            
            # Update Lambda environment variables
            echo "ğŸ”§ Updating Lambda function environment variables..."
            
            # List of Lambda functions to update (match your CDK stack)
            LAMBDA_FUNCTIONS=(
              "ManageCounselorProfilesFunction"
              "GeneratePresignedUrlFunction"
              "GetResultsFunction"
              "GetCounselorDataFunction"
              "GetAnalysisResultsFunction"
              "CheckExecutionStatusFunction"
            )
            
            for FUNCTION_BASE_NAME in "${LAMBDA_FUNCTIONS[@]}"; do
              # Get the actual function name from CloudFormation outputs
              FUNCTION_OUTPUT_KEY="${FUNCTION_BASE_NAME}Name"
              ACTUAL_FUNCTION_NAME=$(aws cloudformation describe-stacks --stack-name $STACK_NAME --region $AWS_REGION --query "Stacks[0].Outputs[?OutputKey=='$FUNCTION_OUTPUT_KEY'].OutputValue" --output text)
              
              if [ ! -z "$ACTUAL_FUNCTION_NAME" ] && [ "$ACTUAL_FUNCTION_NAME" != "None" ]; then
                echo "  ğŸ”„ Updating: $ACTUAL_FUNCTION_NAME"
                
                # Get current environment variables
                CURRENT_ENV=$(aws lambda get-function-configuration --function-name "$ACTUAL_FUNCTION_NAME" --region "$AWS_REGION" --query 'Environment.Variables' --output json 2>/dev/null || echo "{}")
                
                if [ "$CURRENT_ENV" != "{}" ]; then
                  # Update with ALLOWED_ORIGIN using jq
                  UPDATED_ENV=$(echo "$CURRENT_ENV" | jq --arg origin "$AMPLIFY_APP_URL" '. + {ALLOWED_ORIGIN: $origin}')
                  
                  # Update Lambda configuration
                  aws lambda update-function-configuration \
                    --function-name "$ACTUAL_FUNCTION_NAME" \
                    --environment "Variables=$UPDATED_ENV" \
                    --region "$AWS_REGION" > /dev/null 2>&1
                  
                  if [ $? -eq 0 ]; then
                    echo "    âœ… Environment updated for $ACTUAL_FUNCTION_NAME"
                  else
                    echo "    âš ï¸  Could not update environment for $ACTUAL_FUNCTION_NAME"
                  fi
                else
                  echo "    âš ï¸  No environment variables found for $ACTUAL_FUNCTION_NAME"
                fi
              else
                echo "  âš ï¸  Function not found in outputs: $FUNCTION_BASE_NAME"
              fi
            done
            
            echo "âœ… Lambda environment variables update completed"
            
            # Update API Gateway CORS
            echo "ğŸŒ Updating API Gateway CORS..."
            API_ID=$(aws apigateway get-rest-apis --region "$AWS_REGION" --query "items[?name=='Boys Town Hotline QA API'].id" --output text)
            
            if [ ! -z "$API_ID" ] && [ "$API_ID" != "None" ]; then
              echo "  ğŸ”„ API Gateway ID: $API_ID"
              
              # Get all resources
              RESOURCES_JSON=$(aws apigateway get-resources --rest-api-id $API_ID --region $AWS_REGION)
              echo "$RESOURCES_JSON" | jq -r '.items[].id' | while read RESOURCE_ID; do
                RESOURCE_PATH=$(echo "$RESOURCES_JSON" | jq -r ".items[] | select(.id==\"$RESOURCE_ID\") | .path")
                echo "    ğŸ“ Updating resource: $RESOURCE_PATH"
                
                # Update all methods for this resource
                METHODS_JSON=$(aws apigateway get-methods --rest-api-id $API_ID --resource-id $RESOURCE_ID --region $AWS_REGION 2>/dev/null || echo "{}")
                echo "$METHODS_JSON" | jq -r '.items[].httpMethod' 2>/dev/null | while read METHOD_TYPE; do
                  aws apigateway update-integration-response \
                    --rest-api-id $API_ID \
                    --resource-id $RESOURCE_ID \
                    --http-method $METHOD_TYPE \
                    --status-code 200 \
                    --patch-operations \
                      op=replace,path=/responseParameters/method.response.header.Access-Control-Allow-Origin,value="'$AMPLIFY_APP_URL'" \
                    --region $AWS_REGION > /dev/null 2>&1 && echo "      âœ… $METHOD_TYPE" || true
                done
              done
              
              # Deploy API
              aws apigateway create-deployment --rest-api-id $API_ID --stage-name prod --region $AWS_REGION
              echo "  âœ… API Gateway CORS updated and deployed"
            fi
            
            echo ""
            echo "ğŸ‰ CORS configuration successfully restricted!"
            echo "ğŸ”’ Origin: $AMPLIFY_APP_URL"
            echo "ğŸ“¦ Updated: S3 Bucket CORS"
            echo "ğŸ”§ Updated: Lambda Environment Variables"
            echo "ğŸŒ Updated: API Gateway CORS"
            
          else
            echo "âš ï¸  Amplify URL not available, skipping CORS update"
            echo "ğŸ’¡ This usually means the frontend deployment is still in progress"
            echo "ğŸ”§ You can run the CORS update manually later using the update-cors script"
          fi
          
          echo ""
          echo "ğŸ“Š Final Deployment Summary:"
          echo "============================"
          aws cloudformation describe-stacks \
            --stack-name HotlineQaStack-prod \
            --region "$AWS_REGION" \
            --query 'Stacks[0].Outputs[?OutputKey != `StartWorkflowFunctionName` && OutputKey != `TranscribeFunctionName` && OutputKey != `CheckTranscribeStatusFunctionName` && OutputKey != `FormatFunctionName` && OutputKey != `AnalyzeLLMFunctionName` && OutputKey != `AggregateScoresFunctionName` && OutputKey != `UpdateCounselorRecordsFunctionName` && OutputKey != `ManageCounselorProfilesFunctionName` && OutputKey != `GeneratePresignedUrlFunctionName` && OutputKey != `GetResultsFunctionName` && OutputKey != `GetCounselorDataFunctionName` && OutputKey != `GetAnalysisResultsFunctionName` && OutputKey != `CheckExecutionStatusFunctionName`]' \
            --output table || echo "Stack outputs not available or filtered"
          
          echo ""
          echo "ğŸ‰ Boys Town Hotline QA System Deployed Successfully!"
          echo ""
          echo "ğŸ“‹ Next Steps:"
          echo "1. Access your frontend: $AMPLIFY_APP_URL"
          echo "2. Test file upload functionality"
          echo "3. Monitor processing in Step Functions console"
          echo "4. Check CORS is working by testing from different domains"
          
        else
          echo "ğŸ—‘ï¸  Destruction completed successfully!"
          echo "All AWS resources have been removed."
        fi

artifacts:
  files:
    - "**/*"
  base-directory: "cdk.out"

cache:
  paths:
    - "node_modules/**/*"
    - "frontend/node_modules/**/*"
